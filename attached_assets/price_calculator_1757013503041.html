<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Options Sentiment Analyzer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#EFF6FF; color:#383838; }
  .loader { border-top-color:#3B82F6; animation:spin 1s linear infinite; border-radius:9999px; border-width:4px; border-style:solid; border-color:#e5e7eb; width:48px; height:48px; }
  @keyframes spin { 0% {transform: rotate(0deg)} 100% {transform: rotate(360deg)} }
  .accent-color { background-color:#3B82F6; }
  .accent-color:hover { background-color:#2563EB; }
</style>

<!-- Favicon -->
<link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
<link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" type="image/png">
<link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
<meta name="theme-color" content="#3B82F6">

</head>
<body class="antialiased">
  <main class="container mx-auto px-6 md:px-12">
    <div class="w-full my-6">
      <a href="/">
        <img src="{{ url_for('static', filename='images/banner.png') }}" alt="SellingOptions.com Banner" class="w-full h-52 object-cover rounded-lg shadow-md">
      </a>
    </div>

    <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-6">
      <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-900">Options Sentiment Analyzer</h1>
        <p class="text-gray-600 mt-2">Enter a stock symbol to analyze market sentiment based on options data.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
        <div class="col-span-1">
          <label for="stockSymbol" class="block text-sm font-medium text-gray-700 mb-1">Stock Symbol</label>
          <input type="text" id="stockSymbol" placeholder="e.g., TSLA" class="w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="col-span-1">
          <label for="expDate" class="block text-sm font-medium text-gray-700 mb-1">Expiration Date</label>
          <select id="expDate" class="w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
            <option>Enter symbol first</option>
          </select>
        </div>
        <div class="col-span-1">
          <button id="getAnalysisBtn" class="w-full accent-color text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200" disabled>Get Analysis</button>
        </div>
      </div>

      <div id="messageArea" class="text-center hidden pt-4">
        <div id="loader" class="loader mx-auto hidden"></div>
        <p id="messageText" class="text-gray-500 mt-4"></p>
      </div>

      <div id="results" class="hidden space-y-6 pt-6 border-t border-gray-200">
        <div id="quoteRow" class="bg-gray-50 rounded-xl p-4 border border-gray-200 hidden">
          <div class="flex items-center justify-center gap-3">
            <span class="text-sm text-gray-500">Symbol</span>
            <span id="currentSymbol" class="font-semibold text-gray-900"></span>
            <span class="text-sm text-gray-500">Current Price</span>
            <span id="currentPrice" class="font-bold text-blue-600"></span>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
          <div class="bg-gray-100 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-green-600">BULLS WANT</h3>
            <p id="bullsSay" class="text-2xl font-bold text-gray-900"></p>
          </div>
          <div class="bg-gray-100 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-gray-500">AVG CONSENSUS</h3>
            <p id="avgPrice" class="text-2xl font-bold text-gray-900"></p>
          </div>
          <div class="bg-gray-100 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-red-600">BEARS WANT</h3>
            <p id="bearsSay" class="text-2xl font-bold text-gray-900"></p>
          </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
          <div class="bg-gray-100 p-3 rounded-lg">
            <h4 class="text-xs font-medium text-gray-500">Money P/C Ratio</h4>
            <p id="moneyPCR" class="text-lg font-semibold text-gray-900"></p>
          </div>
          <div class="bg-gray-100 p-3 rounded-lg">
            <h4 class="text-xs font-medium text-gray-500">True P/C Ratio</h4>
            <p id="truePCR" class="text-lg font-semibold text-gray-900"></p>
          </div>
          <div class="bg-gray-100 p-3 rounded-lg">
            <h4 class="text-xs font-medium text-gray-500">Premium P/C Ratio</h4>
            <p id="premiumPCR" class="text-lg font-semibold text-gray-900"></p>
          </div>
          <div class="bg-gray-100 p-3 rounded-lg">
            <h4 class="text-xs font-medium text-gray-500">Volume P/C Ratio</h4>
            <p id="volumePCR" class="text-lg font-semibold text-gray-900"></p>
          </div>
          <div class="bg-gray-100 p-3 rounded-lg">
            <h4 class="text-xs font-medium text-gray-500">Vol/OI P/C Ratio</h4>
            <p id="volOiPCR" class="text-lg font-semibold text-gray-900"></p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-gray-800 text-white mt-20">
    <div class="container mx-auto py-8 px-6 md:px-12 text-center">
      <p class="mb-2">&copy; 2025 SellingOptions.com - Built by Wilcotron, LLC - All rights reserved.</p>
      <div class="flex justify-center gap-6">
        <a href="#" class="hover:underline">Privacy Policy</a>
        <a href="#" class="hover:underline">Terms of Service</a>
      </div>
    </div>
  </footer>

  <script type="module">
    const stockSymbolInput = document.getElementById('stockSymbol');
    const expDateSelect = document.getElementById('expDate');
    const getAnalysisBtn = document.getElementById('getAnalysisBtn');
    const messageArea = document.getElementById('messageArea');
    const loader = document.getElementById('loader');
    const messageText = document.getElementById('messageText');
    const resultsDiv = document.getElementById('results');

    const quoteRow = document.getElementById('quoteRow');
    const currentSymbolEl = document.getElementById('currentSymbol');
    const currentPriceEl = document.getElementById('currentPrice');

    let debounceTimer;

    stockSymbolInput.addEventListener('keyup', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async () => {
        const symbol = stockSymbolInput.value.trim().toUpperCase();
        if (symbol) {
          fetchExpirationDates(symbol);
        } else {
          resetForm();
        }
      }, 500);
    });

    getAnalysisBtn.addEventListener('click', async () => {
      const symbol = stockSymbolInput.value.trim().toUpperCase();
      const expDate = expDateSelect.value;
      if (symbol && expDate) {
        await fetchQuote(symbol);
        getAnalysis(symbol, expDate);
      }
    });

    function resetForm() {
      expDateSelect.innerHTML = '<option>Enter symbol first</option>';
      expDateSelect.disabled = true;
      getAnalysisBtn.disabled = true;
      resultsDiv.classList.add('hidden');
      hideMessage();
      quoteRow.classList.add('hidden');
      currentSymbolEl.textContent = '';
      currentPriceEl.textContent = '';
    }

    async function fetchQuote(symbol) {
      try {
        const r = await fetch(`/api/quote?symbol=${encodeURIComponent(symbol)}`);
        if (!r.ok) throw new Error(`Quote error ${r.status}`);
        const data = await r.json();
        currentSymbolEl.textContent = data.symbol;
        currentPriceEl.textContent = `$${Number(data.price).toFixed(2)}`;
        quoteRow.classList.remove('hidden');
      } catch (e) {
        // Hide the quote row on error so it does not confuse the user
        quoteRow.classList.add('hidden');
      }
    }

    function showMessage(msg, showLoader = false) {
      messageArea.classList.remove('hidden');
      messageText.textContent = msg;
      messageText.className = 'text-gray-500 mt-4';
      if (showLoader) loader.classList.remove('hidden'); else loader.classList.add('hidden');
    }

    function showError(msg) {
      showMessage(msg, false);
      messageText.className = 'text-red-500 font-semibold mt-4';
    }

    function hideMessage() {
      messageArea.classList.add('hidden');
    }

    async function fetchExpirationDates(symbol) {
      showMessage('Fetching expiration dates...', true);
      resultsDiv.classList.add('hidden');
      try {
        const response = await fetch(`/api/get_options_data?symbol=${encodeURIComponent(symbol)}`);
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || `API request failed: ${response.status}`);

        const expirations = data;
        if (!expirations || expirations.length === 0) throw new Error(`No options data found for ${symbol}`);

        expDateSelect.innerHTML = '';
        expirations.forEach(dateString => {
          const option = document.createElement('option');
          const date = new Date(dateString + 'T00:00:00');
          const today = new Date();
          today.setHours(0,0,0,0);
          const daysToExp = Math.round((date.getTime() - today.getTime()) / (1000*60*60*24));
          option.value = dateString;
          option.textContent = `${dateString} (${daysToExp} days)`;
          expDateSelect.appendChild(option);
        });

        expDateSelect.disabled = false;
        getAnalysisBtn.disabled = false;
        hideMessage();
      } catch (error) {
        showError(error.message);
        resetForm();
      }
    }

    async function getAnalysis(symbol, date) {
      showMessage('Analyzing options data...', true);
      resultsDiv.classList.add('hidden');
      try {
        const response = await fetch(`/api/get_options_data?symbol=${encodeURIComponent(symbol)}&date=${encodeURIComponent(date)}`);
        const options = await response.json();
        if (!response.ok) throw new Error(options.error || `API request failed: ${response.status}`);

        let calls = options.calls;
        let puts = options.puts;

        const allStrikes = [...calls.map(c => c.strike), ...puts.map(p => p.strike)];
        if (allStrikes.length >= 2) {
          const lowerBound = quantile(allStrikes, 0.025);
          const upperBound = quantile(allStrikes, 0.975);
          calls = calls.filter(c => c.strike >= lowerBound && c.strike <= upperBound);
          puts = puts.filter(p => p.strike >= lowerBound && p.strike <= upperBound);
        }

        const getNum = (val) => (typeof val === 'number' ? val : 0);

        calls.forEach(c => { c.willPay = getNum(c.strike) * getNum(c.openInterest); c.premium = getNum(c.openInterest) * getNum(c.lastPrice) * 100; });
        puts.forEach(p => { p.willPay = getNum(p.strike) * getNum(p.openInterest); p.premium = getNum(p.openInterest) * getNum(p.lastPrice) * 100; });

        const totalBullsWillPay = calls.reduce((s, c) => s + c.willPay, 0);
        const totalBearsWillPay = puts.reduce((s, p) => s + p.willPay, 0);
        const totalBullsPremium = calls.reduce((s, c) => s + c.premium, 0);
        const totalBearsPremium = puts.reduce((s, p) => s + p.premium, 0);
        const totalCallsVolume = calls.reduce((s, c) => s + getNum(c.volume), 0);
        const totalPutsVolume = puts.reduce((s, p) => s + getNum(p.volume), 0);
        const totalCallsOpenInt = calls.reduce((s, c) => s + getNum(c.openInterest), 0);
        const totalPutsOpenInt = puts.reduce((s, p) => s + getNum(p.openInterest), 0);

        calls.forEach(c => c.percentBulls = totalBullsWillPay > 0 ? c.willPay / totalBullsWillPay : 0);
        puts.forEach(p => p.percentBears = totalBearsWillPay > 0 ? p.willPay / totalBearsWillPay : 0);
        calls.forEach(c => c.bullsPart = c.percentBulls * getNum(c.strike));
        puts.forEach(p => p.bearsPart = p.percentBears * getNum(p.strike));

        let bullsSay = calls.reduce((s, c) => s + c.bullsPart, 0);
        const bearsSay = puts.reduce((s, p) => s + p.bearsPart, 0);
        bullsSay = Math.round((bullsSay + 0.005) * 100) / 100;

        const avgPrice = (bullsSay > 0 && bearsSay > 0) ? (bullsSay + bearsSay) / 2 : 0;

        const moneyPCR = totalBullsWillPay > 0 ? totalBearsWillPay / totalBullsWillPay : 0;
        const truePCR = totalCallsOpenInt > 0 ? totalPutsOpenInt / totalCallsOpenInt : 0;
        const premiumPCR = totalBullsPremium > 0 ? totalBearsPremium / totalBullsPremium : 0;
        const volumePCR = totalCallsVolume > 0 ? totalPutsVolume / totalCallsVolume : 0;
        const volOiPCR = truePCR > 0 ? volumePCR / truePCR : 0;

        displayResults({ bullsSay, bearsSay, avgPrice, moneyPCR, truePCR, premiumPCR, volumePCR, volOiPCR });
        hideMessage();
      } catch (error) {
        showError('Analysis failed: ' + error.message);
      }
    }

    function displayResults(data) {
      document.getElementById('bullsSay').textContent = data.bullsSay > 0 ? '$' + data.bullsSay.toFixed(2) : 'N/A';
      document.getElementById('bearsSay').textContent = data.bearsSay > 0 ? '$' + data.bearsSay.toFixed(2) : 'N/A';
      document.getElementById('avgPrice').textContent = data.avgPrice > 0 ? '$' + data.avgPrice.toFixed(2) : 'N/A';
      document.getElementById('moneyPCR').textContent = data.moneyPCR.toFixed(2);
      document.getElementById('truePCR').textContent = data.truePCR.toFixed(2);
      document.getElementById('premiumPCR').textContent = data.premiumPCR.toFixed(2);
      document.getElementById('volumePCR').textContent = data.volumePCR.toFixed(2);
      document.getElementById('volOiPCR').textContent = data.volOiPCR.toFixed(2);
      resultsDiv.classList.remove('hidden');
    }

    function quantile(arr, q) {
      const sorted = arr.slice().sort((a, b) => a - b);
      const pos = (sorted.length - 1) * q;
      const base = Math.floor(pos);
      const rest = pos - base;
      return sorted[base + 1] !== undefined ? sorted[base] + rest * (sorted[base + 1] - sorted[base]) : sorted[base];
    }
  </script>
</body>
</html>